<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Volvo EX30 Plugin Settings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <style>
        .oauth-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .step {
            margin: 1rem 0;
            padding: 1rem;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
        }
        .step.active {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .step.complete {
            border-left-color: #28a745;
            background-color: #d1ecf1;
        }
        .auth-url {
            word-break: break-all;
            background-color: #e9ecef;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .token-display {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            word-break: break-all;
        }
        .loading {
            display: none;
        }
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin: 0.5rem 0;
        }
        .success-message {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h2>üöó Volvo EX30 Plugin Configuration</h2>
                <p class="text-muted">Configure your Volvo EX30 integration with HomeKit</p>

                <!-- Basic Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Basic Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="name">Plugin Name</label>
                            <input type="text" class="form-control" id="name" placeholder="My EX30" value="Volvo EX30">
                        </div>
                        
                        <div class="form-group">
                            <label for="vin">Vehicle VIN</label>
                            <input type="text" class="form-control" id="vin" placeholder="Enter your 17-character VIN" maxlength="17">
                            <small class="form-text text-muted">17-character Vehicle Identification Number</small>
                        </div>

                        <div class="form-group">
                            <label for="region">OAuth Region</label>
                            <select class="form-control" id="region">
                                <option value="eu">EU OAuth Endpoint (volvoid.eu.volvocars.com)</option>
                                <option value="na">NA OAuth Endpoint (volvoid.volvocars.com)</option>
                            </select>
                            <small class="form-text text-muted">Try EU endpoint if NA gives 404 errors</small>
                        </div>
                    </div>
                </div>

                <!-- API Credentials -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Volvo Developer API Credentials</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>üìã Required:</strong> Get these from <a href="https://developer.volvocars.com" target="_blank">Volvo Developer Portal</a>
                        </div>

                        <div class="form-group">
                            <label for="clientId">Client ID</label>
                            <input type="text" class="form-control" id="clientId" placeholder="Your Client ID">
                        </div>

                        <div class="form-group">
                            <label for="clientSecret">Client Secret</label>
                            <input type="password" class="form-control" id="clientSecret" placeholder="Your Client Secret">
                        </div>

                        <div class="form-group">
                            <label for="vccApiKey">VCC API Key</label>
                            <input type="password" class="form-control" id="vccApiKey" placeholder="Primary or Secondary API Key">
                        </div>
                    </div>
                </div>

                <!-- OAuth Setup -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>üîê OAuth Authorization</h5>
                    </div>
                    <div class="card-body">
                        <div id="oauth-section">
                            <div class="alert alert-warning">
                                <strong>‚ö†Ô∏è Required:</strong> You need to complete OAuth authorization to connect to your vehicle.
                            </div>

                            <!-- Step 1: Start OAuth -->
                            <div class="step" id="step1">
                                <h6>Step 1: Start OAuth Authorization</h6>
                                <p>Click the button below to generate your authorization URL.</p>
                                <button type="button" class="btn btn-primary" id="startOAuth">üöÄ Start OAuth Setup</button>
                            </div>

                            <!-- Step 2: Browser Authorization -->
                            <div class="step" id="step2" style="display: none;">
                                <h6>Step 2: Complete Authorization</h6>
                                
                                <p><strong>Open this URL in your browser and sign in with your Volvo ID:</strong></p>
                                <div class="auth-url" id="authUrl"></div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-secondary btn-sm" id="copyUrl">üìã Copy URL</button>
                                    <button type="button" class="btn btn-primary btn-sm" id="openUrl">üåê Open in Browser</button>
                                </div>
                                
                                <div class="mt-4">
                                    <div class="alert alert-warning">
                                        <strong>üìã After Authorization:</strong>
                                        <ol class="mb-0 mt-2">
                                            <li>Click the URL above and sign in with your Volvo ID</li>
                                            <li>Authorize the application</li>
                                            <li><strong>You'll see an error page - this is normal!</strong></li>
                                            <li>Look at your browser's <strong>address bar</strong></li>
                                            <li>Copy the <strong>code</strong> parameter from the URL</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <p><strong>Example of what you'll see in your browser address bar:</strong></p>
                                    <code>https://github.com/jcfield-boop/homebridge-volvoEX30?code=ABC123XYZ789&state=...</code>
                                    <p class="mt-2"><strong>Copy this part:</strong> <code>ABC123XYZ789</code></p>
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success" id="gotCode">‚úÖ I Have the Code - Continue</button>
                                </div>
                            </div>

                            <!-- Step 3: Enter Code -->
                            <div class="step" id="step3" style="display: none;">
                                <h6>Step 3: Enter Authorization Code</h6>
                                <div class="form-group">
                                    <label for="authCode">Authorization Code</label>
                                    <input type="text" class="form-control" id="authCode" placeholder="Paste the code from your browser's address bar">
                                    <small class="form-text text-muted">Paste only the code part (e.g., ABC123XYZ789)</small>
                                </div>
                                <button type="button" class="btn btn-success" id="exchangeToken">üîÑ Get Refresh Token</button>
                                <div class="loading mt-2">
                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                    <span class="ml-2">Exchanging code for tokens...</span>
                                </div>
                            </div>

                            <!-- Step 4: Success -->
                            <div class="step" id="step4" style="display: none;">
                                <h6>‚úÖ Step 4: OAuth Complete!</h6>
                                <div class="success-message">
                                    <strong>Success!</strong> Your refresh token has been obtained and saved.
                                </div>
                                <div class="form-group">
                                    <label for="refreshToken">Refresh Token</label>
                                    <div class="token-display" id="tokenDisplay"></div>
                                    <input type="hidden" id="refreshToken">
                                </div>
                            </div>

                            <div id="errorMessage" class="error-message" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Alternative Setup Method -->
                <div class="card mb-4" style="border-color: #28a745;">
                    <div class="card-header" style="background-color: #d4edda;">
                        <h5>üîë Alternative: Quick Postman Setup (Recommended for Personal Use)</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success">
                            <strong>üí° Quick Win Approach:</strong> Skip the complex OAuth flow above! For personal use, getting your refresh token manually with Postman is much simpler.
                        </div>

                        <div class="accordion" id="postmanAccordion">
                            <div class="card">
                                <div class="card-header" id="postmanHeading">
                                    <h6 class="mb-0">
                                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#postmanCollapse" aria-expanded="true" aria-controls="postmanCollapse">
                                            üìã Click here for step-by-step Postman instructions
                                        </button>
                                    </h6>
                                </div>
                                <div id="postmanCollapse" class="collapse" aria-labelledby="postmanHeading" data-parent="#postmanAccordion">
                                    <div class="card-body">
                                        <ol>
                                            <li><strong>Download Postman:</strong> <a href="https://www.postman.com/downloads/" target="_blank">https://www.postman.com/downloads/</a></li>
                                            <li><strong>Create a new request</strong></li>
                                            <li><strong>Go to Authorization tab ‚Üí Select OAuth 2.0</strong></li>
                                            <li><strong>Configure these settings:</strong>
                                                <ul class="mt-2">
                                                    <li><strong>Token Name:</strong> <code>Volvo EX30</code></li>
                                                    <li><strong>Grant Type:</strong> <code>Authorization Code (With PKCE)</code></li>
                                                    <li><strong>Callback URL:</strong> <code>https://oauth.pstmn.io/v1/callback</code></li>
                                                    <li><strong>Auth URL:</strong> <code>https://volvoid.eu.volvocars.com/as/authorization.oauth2</code></li>
                                                    <li><strong>Access Token URL:</strong> <code>https://volvoid.eu.volvocars.com/as/token.oauth2</code></li>
                                                    <li><strong>Client ID:</strong> <code>dc-s68ezw2gmvo5nmrmfre3j4c28</code></li>
                                                    <li><strong>Client Secret:</strong> <code>AAZIK89F1JF1BKCiJ3yuaW</code></li>
                                                    <li><strong>Scope:</strong> <code>openid</code></li>
                                                    <li><strong>State:</strong> (leave empty)</li>
                                                    <li><strong>Client Authentication:</strong> <code>Send as Basic Auth header</code></li>
                                                </ul>
                                            </li>
                                            <li><strong>Click "Get New Access Token"</strong></li>
                                            <li><strong>Login with your Volvo ID</strong></li>
                                            <li><strong>Copy the <code>refresh_token</code> from the response</strong></li>
                                            <li><strong>Paste it in the "Manual Token Entry" field below</strong></li>
                                        </ol>
                                        
                                        <div class="alert alert-info mt-3">
                                            <strong>üí° Why this works:</strong> The test API has 10,000 calls/day - more than enough for personal use. Manual token setup is perfectly fine and much simpler than perfect OAuth flows!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-3">
                            <label for="manualRefreshToken">Manual Token Entry</label>
                            <input type="text" class="form-control" id="manualRefreshToken" placeholder="Paste your refresh_token from Postman here">
                            <small class="form-text text-muted">If you got a refresh token from Postman or another method, paste it here</small>
                        </div>

                        <button type="button" class="btn btn-success" id="useManualToken">‚úÖ Use Manual Token</button>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>‚öôÔ∏è Advanced Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="pollingInterval">Polling Interval (minutes)</label>
                            <input type="number" class="form-control" id="pollingInterval" min="1" max="60" value="5">
                            <small class="form-text text-muted">How often to check vehicle status (respects API rate limits)</small>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableBattery" checked>
                            <label class="form-check-label" for="enableBattery">
                                Enable Battery Service
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableClimate">
                            <label class="form-check-label" for="enableClimate">
                                Enable Climate Service (Future)
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableLocks">
                            <label class="form-check-label" for="enableLocks">
                                Enable Lock Service (Future)
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableDoors">
                            <label class="form-check-label" for="enableDoors">
                                Enable Door Sensors (Future)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Save Configuration -->
                <div class="card">
                    <div class="card-body">
                        <button type="button" class="btn btn-success btn-lg" id="saveConfig">üíæ Save Configuration</button>
                        <button type="button" class="btn btn-secondary btn-lg ml-2" id="loadConfig">üì• Load Current Config</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
</body>
</html>